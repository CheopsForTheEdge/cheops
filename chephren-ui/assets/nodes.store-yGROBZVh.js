var y=Object.defineProperty;var P=(n,t,u)=>t in n?y(n,t,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[t]=u;var N=(n,t,u)=>(P(n,typeof t!="symbol"?t+"":t,u),u);import{u as D,N as G}from"./nodesUrl.store-PYa8P4uy.js";import{bW as z,h as w,c as f,T as h}from"./index-KEx3fXyj.js";var i=(n=>(n.ONLINE="ONLINE",n.OFFLINE="OFFLINE",n.STARTING="STARTING",n.UNKNOWN="UNKNOWN",n.STOPPING="STOPPING",n.UPDATING="UPDATING",n))(i||{});class m{constructor(t,u=!1){N(this,"name");N(this,"state");N(this,"address");N(this,"resourcesCount");N(this,"loading");Object.assign(this,t),this.loading=u}update(t,u=!1){Object.assign(this,t),this.loading=u}get id(){return`${this.address.host.toLowerCase().normalize().trim()}${this.name.toLowerCase().normalize().trim()}`.split("").map(u=>u.charCodeAt(0).toString(16)).join("")}}const x=z("nodes",()=>{const n=D(),t=w(),u=w(),L="/api/node",p="/api/start",g="/api/stop";async function v(s){try{const e=await fetch(`${s.url}${L}`,{method:"GET"});if(!e.ok)return e.status===403?new m({name:s.name,address:new URL(s.url),state:i.OFFLINE}):new m({name:s.name,address:new URL(s.url),state:i.UNKNOWN});const r=await e.json();return r.name=s.name,r.address=new URL(s.url),new m(r)}catch{return new m({name:s.name,address:new URL(s.url),state:i.OFFLINE})}}async function F(s=!1){if(s&&(t.value=void 0),t.value)return;const e=n.getNodeUrls();!e||e.length===0||(t.value=new Map,e.forEach(r=>{var a;const o=new m({name:r.name,address:new URL(r.url),state:i.UNKNOWN},!0);(a=t.value)==null||a.set(o.id,o),v(r).then(c=>{var l;(l=t.value)==null||l.set(o.id,c)})}),u.value=new Date)}function O(){t.value=void 0}async function T(s){var r,o;const e=(r=t.value)==null?void 0:r.get(s);if(e){e.state=i.STARTING;try{const a=await fetch(`${e.address}${p}`,{method:"PUT"});if(a.ok){const c=new G(e.address,e.name),l=await v(c);e.state=l.state,e.resourcesCount=l.resourcesCount,(o=t.value)==null||o.set(s,e)}else throw new Error(a.statusText)}catch(a){console.error(a),h.addError("Error starting node",a.message),e.state=i.OFFLINE}}}async function E(s){var r,o;const e=(r=t.value)==null?void 0:r.get(s);if(e){e.state=i.STOPPING;try{const a=await fetch(`${e.address}${g}`,{method:"PUT"});if(a.ok)e.state=i.OFFLINE,(o=t.value)==null||o.set(s,e);else throw new Error(a.statusText)}catch(a){console.error(a),h.addError("Error stopping node",a.message),e.state=i.ONLINE}}}function I(s,e){var o;if(!t.value)return;const r=Array.from(t.value.values()).find(a=>a.address.host===s.host);r&&(r.state=e,(o=t.value)==null||o.set(r.id,r))}const d=f(()=>{if(t.value)return Array.from(t.value.values())}),U=f(()=>d.value?d.value.map(s=>({label:s.name??"Unknown name",value:s.id})):[]),C=f(()=>s=>d.value?!s||s.length<1?d.value:d.value.filter(e=>s.some(r=>{var o,a,c;return((o=e.name)==null?void 0:o.toLowerCase().normalize("NFD").includes(r.trim().toLowerCase().normalize("NFD")))||((a=e.state)==null?void 0:a.toLowerCase().normalize("NFD").includes(r.trim().toLowerCase().normalize("NFD")))||((c=e.address)==null?void 0:c.host.toLowerCase().normalize("NFD").includes(r.trim().toLowerCase().normalize("NFD")))})):[]),S=f(()=>s=>{if(d.value)return d.value.find(e=>e.id===s)});return{lastUpdate:u,fetchNodes:F,clearNodes:O,startNode:T,stopNode:E,changeNodeState:I,nodes:d,nodesName:U,getNodeById:S,filteredNodes:C}});export{m as N,i as S,x as u};
